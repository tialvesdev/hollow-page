<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Nova Publicação</title>
  <link rel="shortcut icon" href="../assets/img/icon/hollow-icon.ico" type="image/x-icon">

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.5/dist/sweetalert2.all.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.5/dist/sweetalert2.min.css" rel="stylesheet">

  <link rel="stylesheet" href="../assets/css/global.style.css">
  <link rel="stylesheet" href="../assets/css/new-post.css">

  <script src="../assets/js/validation.js"></script>
</head>

<body>
  <div class="new-post-wrapper">
    <!-- form action="/upload" method="POST" enctype="multipart/form-data" -->
    <main class="np-main">
      <section class="np-sect">
        <aside class="np-aside">
          <h1 class="title">Nova publicação:</h1>
          <input type="text" class="ipt" id="ipt_titulo" placeholder="Título" />
          <textarea onkeypress="textAreaAdjust(this)" style="overflow:hidden" class="ipt" id="ipt_desc" placeholder="Descrição"></textarea>
          <img src="../assets/img/char/chars-on-bench.png" alt="">
        </aside>

        <aside class="np-aside">
          <img src="../assets/img/char/knight-crying.png" alt="Nenhuma foto selecionada" class="ipt-file-img" id="ipt_file_img" >
          <p class="text ipt-file-name" id="ipt_ile_name" >Nenhuma foto selecionada</p>
          <label for="ipt_file" class="ipt-file-label">
            <input name="imagem" class="ipt-file sumir" type="file" id="ipt_file" accept="image/*" onchange="previewImage(event)" />
            <a class="ipt-file-a big-text"><b> Escolher foto </b></a>
          </label>
        </aside>
      </section>
      <button onclick="post()" class="btn">Publicar</button>
    </main>
  </div>
</body>

</html>

<script>
  function post() {
    
    var dadosNewPost = [
      ipt_titulo.value,
      ipt_desc.value,
      ipt_file.files[0]
    ];

    var foto = `../assets/bucket/${dadosNewPost[2].name}`;

    console.log(dadosNewPost[0], dadosNewPost[1], sessionStorage.ID_USUARIO)

    // if (validarTexto('Título', dadosNewPost[0], 100) && validarTexto('Descrição', dadosNewPost[1], 300)) {
    //   console.log('Publicação adicionada com sucesso');
    //   Swal.fire({
    //     icon: 'success',
    //     title: 'Publicação criada!',
    //     text: 'Redirecionando em instantes...',
    //     background: '#000',
    //     color: '#FFF',
    //   });
    // } else {
    //   console.log('Publicação inválida');
    //   Swal.fire({
    //     icon: dadosAlerta[0],
    //     title: dadosAlerta[1],
    //     text: dadosAlerta[2],
    //     background: '#000',
    //     color: '#FFF',
    //   })
    // }

    // Enviando o valor da nova input
    fetch("/posts/post", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                // crie um atributo que recebe o valor recuperado aqui
                // Agora vá para o arquivo routes/usuario.js
                tituloServer: dadosNewPost[0],
                descricaoServer: dadosNewPost[1],
                fotoServer: foto,
                idUsuarioServer: sessionStorage.ID_USUARIO
            })
        }).then(function (resposta) {

            console.log("resposta: ", resposta);

            if (resposta.ok) {
                // cardErro.style.display = "block";

                // mensagem_erro.innerHTML = "Cadastro realizado com sucesso! Redirecionando para tela de Login...";

                alert('postou certinho');

                setTimeout(() => {
                    window.location = "./feed.html";
                }, "2000")

                // limparFormulario();
                // finalizarAguardar();
            } else {
                throw ("Houve um erro ao tentar realizar o post!");
                alert('ish deu erro, to no else');
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
            alert('aiai viu, to no catch do erro');
            // finalizarAguardar();
        });

        return false;
  }

  function textAreaAdjust(element) {
    // element.style.height = "1px";
    console.log(`(scrollHeight: ${element.scrollHeight} > clientHeight: ${element.clientHeight}) ? (scrollHeight: ${element.scrollHeight}px) : "40px"`);
    element.style.height = (element.scrollHeight > element.clientHeight) ? (element.scrollHeight)+"px" : "40px";
  }

  /**
   * Create an arrow function that will be called when an image is selected.
   */
  const previewImage = (event) => {
    /*** Get the selected files.*/
    const imageFiles = event.target.files;

    console.log(imageFiles, imageFiles[0], imageFiles[0].name)

    var img = document.getElementById('ipt_file_img');
    var name = document.getElementById('ipt_ile_name');

    img.src = URL.createObjectURL(imageFiles[0]);
    img.style.display = 'block';
    name.innerHTML = imageFiles[0].name;
    name.style.display = 'block';

    console.log(URL.createObjectURL(imageFiles[0]));
  };
</script>